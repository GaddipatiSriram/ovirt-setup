---
# install_engine.yml - Install oVirt Engine standalone with local databases
# Reference: https://www.ovirt.org/documentation/installing_ovirt_as_a_standalone_manager_with_local_databases/
# Run: ansible-playbook -i inventory.ini install_engine.yml

- name: Install oVirt Engine
  hosts: engine
  become: true
  gather_facts: true

  pre_tasks:
    - name: Assert running on EL9
      ansible.builtin.assert:
        that:
          - ansible_distribution_major_version == "9"
          - ansible_os_family == "RedHat"
        fail_msg: "This playbook only supports EL9 (Rocky/RHEL/AlmaLinux 9). Do not run on EL8/EL10."
        success_msg: "Running on supported EL9 system"

  tasks:
    # Install oVirt Engine package per official docs
    - name: Install oVirt Engine packages
      ansible.builtin.dnf:
        name:
          - ovirt-engine
        state: present

    # Generate answer file for unattended setup
    - name: Generate engine-setup answer file
      ansible.builtin.template:
        src: ../../templates/engine-answers.conf.j2
        dest: /root/engine-answers.conf
        owner: root
        group: root
        mode: '0600'

    # Check if engine is already configured
    - name: Check if engine is already configured
      ansible.builtin.stat:
        path: /etc/ovirt-engine/engine.conf.d/10-setup-protocols.conf
      register: engine_configured

    # Run engine-setup with answer file
    - name: Run engine-setup (this takes several minutes)
      ansible.builtin.command: >
        engine-setup --config-append=/root/engine-answers.conf --accept-defaults
      register: engine_setup_result
      changed_when: engine_setup_result.rc == 0
      failed_when: engine_setup_result.rc != 0
      when: not engine_configured.stat.exists
      environment:
        LANG: en_US.UTF-8
        LC_ALL: en_US.UTF-8

    - name: Display engine-setup output
      ansible.builtin.debug:
        var: engine_setup_result.stdout_lines
      when: engine_setup_result is defined and engine_setup_result.stdout_lines is defined

    # Configure JVM heap size (override auto-calculated value)
    - name: Configure oVirt Engine JVM heap size
      ansible.builtin.copy:
        dest: /etc/ovirt-engine/engine.conf.d/20-custom-heap.conf
        content: |
          ENGINE_HEAP_MIN="{{ ovirt_engine_heap_min }}"
          ENGINE_HEAP_MAX="{{ ovirt_engine_heap_max }}"
        owner: root
        group: root
        mode: '0644'
      notify: Restart ovirt-engine

    # Ensure services are running
    - name: Ensure ovirt-engine service is enabled and started
      ansible.builtin.systemd:
        name: ovirt-engine
        state: started
        enabled: true

    - name: Ensure ovirt-engine-dwhd service is enabled and started
      ansible.builtin.systemd:
        name: ovirt-engine-dwhd
        state: started
        enabled: true
      ignore_errors: true

    - name: Ensure ovirt-imageio service is enabled and started
      ansible.builtin.systemd:
        name: ovirt-imageio
        state: started
        enabled: true
      ignore_errors: true

    - name: Ensure ovirt-vmconsole-proxy-sshd service is enabled and started
      ansible.builtin.systemd:
        name: ovirt-vmconsole-proxy-sshd
        state: started
        enabled: true
      ignore_errors: true

    - name: Ensure ovirt-websocket-proxy service is enabled and started
      ansible.builtin.systemd:
        name: ovirt-websocket-proxy
        state: started
        enabled: true
      ignore_errors: true

    # Wait for engine API to be available
    - name: Wait for oVirt Engine API to be ready
      ansible.builtin.uri:
        url: "https://{{ ovirt_engine_fqdn }}/ovirt-engine/api"
        method: GET
        validate_certs: false
        status_code: [200, 401]
      register: api_result
      until: api_result.status | default(0) in [200, 401]
      retries: 30
      delay: 10
      ignore_errors: true

    - name: Display engine access information
      ansible.builtin.debug:
        msg:
          - "=============================================="
          - "oVirt Engine installation complete!"
          - "=============================================="
          - "Admin Portal: https://{{ ovirt_engine_fqdn }}/ovirt-engine/"
          - "VM Portal: https://{{ ovirt_engine_fqdn }}/ovirt-engine/web-ui"
          - "Username: admin@internal"
          - "Password: {{ ovirt_engine_admin_password }}"
          - "=============================================="
          - "CA Certificate: https://{{ ovirt_engine_fqdn }}/ovirt-engine/services/pki-resource?resource=ca-certificate&format=X509-PEM-CA"
          - "=============================================="
          - "Next: Run post_install.yml to add host and storage"
          - "=============================================="

  handlers:
    - name: Restart ovirt-engine
      ansible.builtin.systemd:
        name: ovirt-engine
        state: restarted
