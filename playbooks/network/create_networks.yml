---
# create_networks.yml - Create VLAN networks and attach to host
# Run: ansible-playbook -i inventory.ini network/create_networks.yml
#
# 3-Tier Network Architecture (11 networks):
#   - Management: VLAN 10-14 (5 networks: Core, DevOps, Observability, Storage, Forge)
#   - Development: VLAN 20-22 (3 networks: Web, Apps, Data)
#   - Production:  VLAN 30-32 (3 networks: Web, Apps, Data)

- name: Create VLAN Networks (3-Tier Architecture)
  hosts: engine
  become: false
  gather_facts: false

  vars:
    datacenter_name: "Default"
    cluster_name: "Default"
    host_name: "node"
    nic_name: "eno1"

    # 3-Tier VLAN networks (11 total)
    vlan_networks:
      # Management networks (VLAN 10-14)
      - name: "Mgmt-Core-Net"
        vlan_id: 10
        subnet: "10.10.1.0/24"
        gateway: "10.10.1.1"
        description: "Core infrastructure - CoreDNS, Keycloak, Vault"

      - name: "Mgmt-DevOps-Net"
        vlan_id: 11
        subnet: "10.10.2.0/24"
        gateway: "10.10.2.1"
        description: "DevOps - OKD, ArgoCD, OCM, Backstage"

      - name: "Mgmt-Observ-Net"
        vlan_id: 12
        subnet: "10.10.3.0/24"
        gateway: "10.10.3.1"
        description: "Observability - Prometheus, Grafana, Loki, Tempo"

      - name: "Mgmt-Storage-Net"
        vlan_id: 13
        subnet: "10.10.4.0/24"
        gateway: "10.10.4.1"
        description: "Storage - Rook-Ceph, NFS, S3, RBD"

      - name: "Mgmt-Forge-Net"
        vlan_id: 14
        subnet: "10.10.5.0/24"
        gateway: "10.10.5.1"
        description: "Software Forge - GitLab, Harbor, SonarQube"

      # Development networks (VLAN 20-22) - 3-Tier
      - name: "Dev-Web-Net"
        vlan_id: 20
        subnet: "10.20.1.0/24"
        gateway: "10.20.1.1"
        description: "Dev Web Tier - Ingress, nginx, HAProxy, CDN cache"

      - name: "Dev-Apps-Net"
        vlan_id: 21
        subnet: "10.20.2.0/24"
        gateway: "10.20.2.1"
        description: "Dev Apps Tier - API servers, microservices, K8s workers"

      - name: "Dev-Data-Net"
        vlan_id: 22
        subnet: "10.20.3.0/24"
        gateway: "10.20.3.1"
        description: "Dev Data Tier - PostgreSQL, Redis, Kafka, Elasticsearch"

      # Production networks (VLAN 30-32) - 3-Tier
      - name: "Prod-Web-Net"
        vlan_id: 30
        subnet: "10.30.1.0/24"
        gateway: "10.30.1.1"
        description: "Prod Web Tier - Ingress, nginx, HAProxy, CDN cache"

      - name: "Prod-Apps-Net"
        vlan_id: 31
        subnet: "10.30.2.0/24"
        gateway: "10.30.2.1"
        description: "Prod Apps Tier - API servers, microservices, K8s workers"

      - name: "Prod-Data-Net"
        vlan_id: 32
        subnet: "10.30.3.0/24"
        gateway: "10.30.3.1"
        description: "Prod Data Tier - PostgreSQL, Redis, Kafka, Elasticsearch"

  tasks:
    - name: Obtain SSO token from oVirt Engine
      ovirt.ovirt.ovirt_auth:
        url: "https://{{ ovirt_engine_fqdn }}/ovirt-engine/api"
        username: "admin@ovirt@internalsso"
        password: "{{ ovirt_engine_admin_password }}"
        insecure: true
      register: ovirt_auth

    # ==================== STEP 1: CREATE VLAN NETWORKS ====================
    - name: Create VLAN networks in datacenter
      ovirt.ovirt.ovirt_network:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        name: "{{ item.name }}"
        data_center: "{{ datacenter_name }}"
        description: "{{ item.description }} ({{ item.subnet }}) - GW: {{ item.gateway }}"
        vlan_tag: "{{ item.vlan_id }}"
        vm_network: true
        mtu: 1500
        state: present
      loop: "{{ vlan_networks }}"
      loop_control:
        label: "{{ item.name }} (VLAN {{ item.vlan_id }})"

    # ==================== STEP 2: ASSIGN TO DEFAULT CLUSTER ====================
    - name: Assign networks to Default cluster (required=false)
      ovirt.ovirt.ovirt_network:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        name: "{{ item.name }}"
        data_center: "{{ datacenter_name }}"
        clusters:
          - name: "{{ cluster_name }}"
            assigned: true
            required: false
            migration: false
            display: false
        state: present
      loop: "{{ vlan_networks }}"
      loop_control:
        label: "{{ item.name }} -> {{ cluster_name }}"

    # ==================== STEP 3: ATTACH TO HOST NIC ====================
    - name: Attach VLAN networks to host NIC
      ovirt.ovirt.ovirt_host_network:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        name: "{{ host_name }}"
        interface: "{{ nic_name }}"
        networks:
          - name: "{{ item.name }}"
        save: true
      loop: "{{ vlan_networks }}"
      loop_control:
        label: "{{ item.name }} -> {{ nic_name }}.{{ item.vlan_id }}"

    # ==================== CLEANUP ====================
    - name: Revoke SSO token
      ovirt.ovirt.ovirt_auth:
        state: absent
        ovirt_auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"

    - name: Display summary
      ansible.builtin.debug:
        msg:
          - "=============================================="
          - "VLAN Networks Setup Complete (3-Tier)"
          - "=============================================="
          - ""
          - "MANAGEMENT (VLAN 10-14):"
          - "  {{ nic_name }}.10  Mgmt-Core-Net     10.10.1.0/24  (CoreDNS, Keycloak, Vault)"
          - "  {{ nic_name }}.11  Mgmt-DevOps-Net   10.10.2.0/24  (OKD, ArgoCD, OCM)"
          - "  {{ nic_name }}.12  Mgmt-Observ-Net   10.10.3.0/24  (Prometheus, Grafana)"
          - "  {{ nic_name }}.13  Mgmt-Storage-Net  10.10.4.0/24  (Rook-Ceph, NFS, S3)"
          - "  {{ nic_name }}.14  Mgmt-Forge-Net    10.10.5.0/24  (GitLab, Harbor, SonarQube)"
          - ""
          - "DEVELOPMENT (VLAN 20-22) - 3-Tier:"
          - "  {{ nic_name }}.20  Dev-Web-Net       10.20.1.0/24  (Ingress, nginx, HAProxy)"
          - "  {{ nic_name }}.21  Dev-Apps-Net      10.20.2.0/24  (API, microservices, K8s)"
          - "  {{ nic_name }}.22  Dev-Data-Net      10.20.3.0/24  (PostgreSQL, Redis, Kafka)"
          - ""
          - "PRODUCTION (VLAN 30-32) - 3-Tier:"
          - "  {{ nic_name }}.30  Prod-Web-Net      10.30.1.0/24  (Ingress, nginx, HAProxy)"
          - "  {{ nic_name }}.31  Prod-Apps-Net     10.30.2.0/24  (API, microservices, K8s)"
          - "  {{ nic_name }}.32  Prod-Data-Net     10.30.3.0/24  (PostgreSQL, Redis, Kafka)"
          - ""
          - "=============================================="
          - "Total: 11 VLAN networks ready for VMs"
          - "=============================================="
