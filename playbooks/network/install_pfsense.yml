---
# install_pfsense.yml - Download ISO, create and configure pfSense VM
# Run: ansible-playbook playbooks/network/install_pfsense.yml

- name: Install pfSense VM
  hosts: engine
  become: true
  gather_facts: false

  vars:
    vm_name: "pfSense"
    vm_memory: 4GiB
    vm_cpu_sockets: 1
    vm_cpu_cores: 2
    vm_disk_size: 50GiB
    storage_domain: "data_lun"
    cluster_name: "Default"

    # pfSense ISO settings
    pfsense_version: "2.7.2"
    iso_name: "pfSense-CE-{{ pfsense_version }}-RELEASE-amd64.iso"
    pfsense_url: "https://atxfiles.netgate.com/mirror/downloads/pfSense-CE-{{ pfsense_version }}-RELEASE-amd64.iso.gz"
    download_dir: "/tmp"

    # pfSense WAN static configuration
    pfsense_wan_mac: "56:6f:1b:6a:00:77"
    pfsense_wan_ip: "192.168.0.101"
    pfsense_wan_gateway: "192.168.0.1"

    # Networks for pfSense (10 interfaces total - 3-Tier Architecture)
    pfsense_networks:
      - name: "ovirtmgmt"
        nic_name: "nic1"
        pfsense_name: "WAN"
        mac_address: "{{ pfsense_wan_mac }}"
        ip_address: "{{ pfsense_wan_ip }}"

      - name: "Mgmt-Core-Net"
        nic_name: "nic2"
        pfsense_name: "MGMT_CORE"
        ip_address: "10.10.1.1"

      - name: "Mgmt-DevOps-Net"
        nic_name: "nic3"
        pfsense_name: "MGMT_DEVOPS"
        ip_address: "10.10.2.1"

      - name: "Mgmt-Observ-Net"
        nic_name: "nic4"
        pfsense_name: "MGMT_OBSERV"
        ip_address: "10.10.3.1"

      - name: "Dev-Web-Net"
        nic_name: "nic5"
        pfsense_name: "DEV_WEB"
        ip_address: "10.20.1.1"

      - name: "Dev-Apps-Net"
        nic_name: "nic6"
        pfsense_name: "DEV_APPS"
        ip_address: "10.20.2.1"

      - name: "Dev-Data-Net"
        nic_name: "nic7"
        pfsense_name: "DEV_DATA"
        ip_address: "10.20.3.1"

      - name: "Prod-Web-Net"
        nic_name: "nic8"
        pfsense_name: "PROD_WEB"
        ip_address: "10.30.1.1"

      - name: "Prod-Apps-Net"
        nic_name: "nic9"
        pfsense_name: "PROD_APPS"
        ip_address: "10.30.2.1"

      - name: "Prod-Data-Net"
        nic_name: "nic10"
        pfsense_name: "PROD_DATA"
        ip_address: "10.30.3.1"

  tasks:
    - name: Authenticate to oVirt
      ovirt.ovirt.ovirt_auth:
        url: "https://{{ ovirt_engine_fqdn }}/ovirt-engine/api"
        username: "admin@ovirt@internalsso"
        password: "{{ ovirt_engine_admin_password }}"
        insecure: true
      register: ovirt_auth

    - name: Check for existing ISO disk
      ovirt.ovirt.ovirt_disk_info:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        pattern: "name={{ iso_name }}"
      register: iso_check

    - name: Download and upload pfSense ISO if not exists
      when: iso_check.ovirt_disks | length == 0
      block:
        - name: Install required packages
          ansible.builtin.dnf:
            name:
              - gzip
              - python3-ovirt-engine-sdk4
            state: present

        - name: Download pfSense ISO (compressed)
          ansible.builtin.get_url:
            url: "{{ pfsense_url }}"
            dest: "{{ download_dir }}/{{ iso_name }}.gz"
            mode: '0644'
            timeout: 600

        - name: Decompress pfSense ISO
          ansible.builtin.command:
            cmd: "gunzip -f {{ download_dir }}/{{ iso_name }}.gz"
            creates: "{{ download_dir }}/{{ iso_name }}"

        - name: Get ISO file size
          ansible.builtin.stat:
            path: "{{ download_dir }}/{{ iso_name }}"
          register: iso_stat

        - name: Display ISO info
          ansible.builtin.debug:
            msg: "Downloaded {{ iso_name }} ({{ (iso_stat.stat.size / 1024 / 1024) | round(1) }} MB)"

        - name: Upload pfSense ISO to oVirt
          ovirt.ovirt.ovirt_disk:
            auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
            name: "{{ iso_name }}"
            description: "pfSense CE {{ pfsense_version }} installation ISO"
            storage_domain: "{{ storage_domain }}"
            upload_image_path: "{{ download_dir }}/{{ iso_name }}"
            size: "{{ iso_stat.stat.size }}"
            format: raw
            content_type: iso
            bootable: true
            sparse: false
            wait: true
            timeout: 600

        - name: Clean up downloaded ISO
          ansible.builtin.file:
            path: "{{ download_dir }}/{{ iso_name }}"
            state: absent

    - name: ISO already exists
      ansible.builtin.debug:
        msg: "pfSense ISO already exists in oVirt, skipping download"
      when: iso_check.ovirt_disks | length > 0

    - name: Create pfSense VM
      ovirt.ovirt.ovirt_vm:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        name: "{{ vm_name }}"
        cluster: "{{ cluster_name }}"
        memory: "{{ vm_memory }}"
        memory_guaranteed: "{{ vm_memory }}"
        memory_max: 8GiB
        cpu_sockets: "{{ vm_cpu_sockets }}"
        cpu_cores: "{{ vm_cpu_cores }}"
        operating_system: other
        type: server
        bios_type: q35_sea_bios
        graphical_console:
          protocol:
            - vnc
        state: present
      register: vm_result

    - name: Create pfSense disk
      ovirt.ovirt.ovirt_disk:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        name: "{{ vm_name }}_Disk"
        vm_name: "{{ vm_name }}"
        size: "{{ vm_disk_size }}"
        format: cow
        storage_domain: "{{ storage_domain }}"
        interface: virtio_scsi
        bootable: true
        state: present
      when: vm_result.changed

    - name: Add vNICs to pfSense VM
      ovirt.ovirt.ovirt_nic:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        vm: "{{ vm_name }}"
        name: "{{ item.nic_name }}"
        profile: "{{ item.name }}"
        network: "{{ item.name }}"
        # WAN (nic1) uses e1000 for better pfSense compatibility, LANs use virtio
        interface: "{{ 'e1000' if item.nic_name == 'nic1' else 'virtio' }}"
        mac_address: "{{ item.mac_address | default(omit) }}"
        state: present
      loop: "{{ pfsense_networks }}"
      loop_control:
        label: "{{ item.nic_name }} -> {{ item.name }} ({{ item.pfsense_name }}) [{{ 'e1000' if item.nic_name == 'nic1' else 'virtio' }}]"

    - name: Attach pfSense ISO and start VM
      ovirt.ovirt.ovirt_vm:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        name: "{{ vm_name }}"
        cd_iso: "{{ iso_name }}"
        boot_devices:
          - cdrom
          - hd
        state: running

    - name: Revoke SSO token
      ovirt.ovirt.ovirt_auth:
        state: absent
        ovirt_auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"

    - name: Display summary
      ansible.builtin.debug:
        msg:
          - "=============================================="
          - "pfSense VM Created - Ready for Installation"
          - "=============================================="
          - ""
          - "VM Settings:"
          - "  Name: {{ vm_name }}"
          - "  Memory: {{ vm_memory }}"
          - "  CPU: {{ vm_cpu_sockets }} socket x {{ vm_cpu_cores }} cores"
          - "  Disk: {{ vm_disk_size }} on {{ storage_domain }}"
          - ""
          - "Network Interfaces (10 total - 3-Tier):"
          - "  nic1  (em0)    -> ovirtmgmt        WAN          {{ pfsense_wan_ip }} [e1000]"
          - "  nic2  (vtnet0) -> Mgmt-Core-Net    MGMT_CORE    10.10.1.1  [virtio]"
          - "  nic3  (vtnet1) -> Mgmt-DevOps-Net  MGMT_DEVOPS  10.10.2.1  [virtio]"
          - "  nic4  (vtnet2) -> Mgmt-Observ-Net  MGMT_OBSERV  10.10.3.1  [virtio]"
          - "  nic5  (vtnet3) -> Dev-Web-Net      DEV_WEB      10.20.1.1  [virtio]"
          - "  nic6  (vtnet4) -> Dev-Apps-Net     DEV_APPS     10.20.2.1  [virtio]"
          - "  nic7  (vtnet5) -> Dev-Data-Net     DEV_DATA     10.20.3.1  [virtio]"
          - "  nic8  (vtnet6) -> Prod-Web-Net     PROD_WEB     10.30.1.1  [virtio]"
          - "  nic9  (vtnet7) -> Prod-Apps-Net    PROD_APPS    10.30.2.1  [virtio]"
          - "  nic10 (vtnet8) -> Prod-Data-Net    PROD_DATA    10.30.3.1  [virtio]"
          - ""
          - "=============================================="
          - "Next Steps:"
          - "  1. Open noVNC console in oVirt Admin Portal"
          - "  2. Install pfSense from ISO"
          - "  3. Run: ansible-playbook playbooks/network/post_install_pfsense.yml"
          - "=============================================="
