---
# configure_dns.yml - Configure DNS settings on pfSense
# Run: ansible-playbook playbooks/network/pfsense/configure_dns.yml
#
# This playbook configures:
#   - DNS domain overrides (forward specific domains to other DNS servers)
#   - DHCP search domain for short name resolution
#   - OKD DNS host overrides (api.*, api-int.*, *.apps.*)
#
# Prerequisites:
#   - pfSense VM running with SSH enabled
#   - ansible-galaxy collection install pfsensible.core
#   - CoreDNS deployed on K8s cluster (for domain override target)
#
# Usage:
#   # Full DNS configuration
#   ansible-playbook playbooks/network/pfsense/configure_dns.yml
#
#   # Only configure domain overrides
#   ansible-playbook playbooks/network/pfsense/configure_dns.yml --tags domain-override
#
#   # Only update DHCP search domain
#   ansible-playbook playbooks/network/pfsense/configure_dns.yml --tags dhcp
#
#   # Only configure OKD DNS entries
#   ansible-playbook playbooks/network/pfsense/configure_dns.yml --tags okd

- name: Configure DNS on pfSense
  hosts: pfsense
  gather_facts: false
  become: false

  vars_files:
    - vars/dns_config.yml

  tasks:
    # =========================================================================
    # PHASE 1: DNS DOMAIN OVERRIDES
    # =========================================================================
    - name: "PHASE 1: DNS Domain Overrides"
      tags: [domain-override]
      block:
        - name: Configure DNS resolver with domain overrides
          pfsensible.core.pfsense_dns_resolver:
            state: present
            dnssec: false
            forwarding: true
            regdhcp: true
            regdhcpstatic: true
            domainoverrides: "{{ dns_domain_overrides }}"

    # =========================================================================
    # PHASE 2: DHCP SEARCH DOMAIN
    # =========================================================================
    - name: "PHASE 2: DHCP Search Domain Configuration"
      tags: [dhcp]
      block:
        - name: Update DHCP servers with search domain
          pfsensible.core.pfsense_dhcp_server:
            interface: "{{ item.interface }}"
            enable: true
            range_from: "{{ item.range_from }}"
            range_to: "{{ item.range_to }}"
            domain: "{{ dns_search_domain }}"
            defaultleasetime: 86400
            maxleasetime: 172800
            state: present
          loop: "{{ dhcp_interfaces }}"
          loop_control:
            label: "{{ item.interface }} ({{ dns_search_domain }})"

    # =========================================================================
    # PHASE 3: OKD DNS HOST OVERRIDES
    # =========================================================================
    - name: "PHASE 3: OKD DNS Configuration"
      tags: [okd]
      when: okd_dns_entries is defined
      block:
        - name: Configure OKD DNS host overrides via PHP
          ansible.builtin.raw: |
            /usr/local/bin/php -r '
            require_once("config.inc");
            require_once("unbound.inc");
            global $config;

            // Host override to add
            $host = "{{ item.host }}";
            $domain = "{{ item.domain }}";
            $ip = "{{ item.ip }}";
            $descr = "{{ item.descr | default('') }}";

            // Initialize hosts array if not exists
            if (!isset($config["unbound"]["hosts"])) {
                $config["unbound"]["hosts"] = array();
            }

            // Check if entry already exists
            $found = false;
            foreach ($config["unbound"]["hosts"] as $key => $entry) {
                if ($entry["host"] == $host && $entry["domain"] == $domain) {
                    // Update existing entry
                    $config["unbound"]["hosts"][$key]["ip"] = $ip;
                    $config["unbound"]["hosts"][$key]["descr"] = $descr;
                    $found = true;
                    break;
                }
            }

            // Add new entry if not found
            if (!$found) {
                $config["unbound"]["hosts"][] = array(
                    "host" => $host,
                    "domain" => $domain,
                    "ip" => $ip,
                    "descr" => $descr
                );
            }

            write_config("Added DNS host override: " . $host . "." . $domain);
            services_unbound_configure();
            echo "Configured: " . $host . "." . $domain . " -> " . $ip;
            '
          loop: "{{ okd_dns_entries }}"
          loop_control:
            label: "{{ item.host }}.{{ item.domain }} -> {{ item.ip }}"
          changed_when: true

        # NOTE: Wildcard DNS for *.apps.okd.engatwork.com is handled by CoreDNS
        # on mgmt-core cluster, not by pfSense domain overrides.

    # =========================================================================
    # SUMMARY
    # =========================================================================
    - name: Display DNS configuration summary
      tags: [always]
      ansible.builtin.debug:
        msg:
          - "=============================================="
          - "pfSense DNS Configuration Complete"
          - "=============================================="
          - ""
          - "DNS Domain Overrides:"
          - "{% for override in dns_domain_overrides %}  {{ override.domain }} -> {{ override.ip }}{% if override.descr is defined %} ({{ override.descr }}){% endif %}\n{% endfor %}"
          - ""
          - "DHCP Search Domain: {{ dns_search_domain }}"
          - "Configured on {{ dhcp_interfaces | length }} interfaces"
          - ""
          - "OKD DNS Entries (if configured):"
          - "{% if okd_dns_entries is defined %}{% for entry in okd_dns_entries %}  {{ entry.host }}.{{ entry.domain }} -> {{ entry.ip }}\n{% endfor %}{% else %}  Not configured{% endif %}"
          - ""
          - "OKD Apps Wildcard DNS:"
          - "  Handled by CoreDNS on mgmt-core cluster (10.10.1.200)"
          - ""
          - "Next Steps:"
          - "  - VMs need to renew DHCP lease or reboot"
          - "  - Test: dig api.okd.engatwork.com"
          - "  - Test: dig console-openshift-console.apps.okd.engatwork.com"
          - "=============================================="
