---
# configure_pfsense.yml - Configure pfSense firewall using pfsensible.core
# Run: ansible-playbook playbooks/network/pfsense/configure_pfsense.yml
#
# Prerequisites:
#   - pfSense VM running with SSH enabled
#   - ansible-galaxy collection install pfsensible.core
#
# Usage:
#   ansible-playbook playbooks/network/pfsense/configure_pfsense.yml

- name: Configure pfSense Firewall
  hosts: pfsense
  gather_facts: false
  become: false  # pfSense SSH as admin runs as root

  vars_files:
    - vars/pfsense_config.yml

  tasks:
    # =========================================================================
    # PHASE 1: SYSTEM CONFIGURATION
    # =========================================================================
    - name: "PHASE 1: System Configuration"
      tags: [system]
      block:
        - name: Configure system settings
          pfsensible.core.pfsense_setup:
            hostname: "{{ pfsense_hostname }}"
            domain: "{{ pfsense_domain }}"
            timezone: "{{ pfsense_timezone }}"
            dns_addresses: "{{ pfsense_dns_servers | join(' ') }}"
            dnsallowoverride: false

        - name: Configure DNS Resolver
          pfsensible.core.pfsense_dns_resolver:
            state: present
            dnssec: false
            forwarding: true
            regdhcp: true
            regdhcpstatic: true

    # =========================================================================
    # PHASE 2: INTERFACE CONFIGURATION
    # =========================================================================
    - name: "PHASE 2: Interface Configuration"
      tags: [interfaces]
      block:
        # First configure WAN interface without gateway
        - name: Configure WAN interface (initial)
          pfsensible.core.pfsense_interface:
            interface: "{{ pfsense_wan.interface }}"
            descr: "{{ pfsense_wan.descr }}"
            ipv4_type: "{{ pfsense_wan.ipv4_type }}"
            ipv4_address: "{{ pfsense_wan.ipv4_address }}"
            ipv4_prefixlen: "{{ pfsense_wan.ipv4_prefixlen }}"
            blockpriv: "{{ pfsense_wan.blockpriv }}"
            blockbogons: "{{ pfsense_wan.blockbogons }}"
            enable: true
            state: present

        # Then create the gateway
        - name: Configure WAN gateway
          pfsensible.core.pfsense_gateway:
            name: "{{ pfsense_wan_gateway.name }}"
            interface: "{{ pfsense_wan_gateway.interface }}"
            gateway: "{{ pfsense_wan_gateway.gateway }}"
            ipprotocol: inet
            state: present

        # Now update WAN interface with gateway reference
        - name: Configure WAN interface (with gateway)
          pfsensible.core.pfsense_interface:
            interface: "{{ pfsense_wan.interface }}"
            descr: "{{ pfsense_wan.descr }}"
            ipv4_type: "{{ pfsense_wan.ipv4_type }}"
            ipv4_address: "{{ pfsense_wan.ipv4_address }}"
            ipv4_prefixlen: "{{ pfsense_wan.ipv4_prefixlen }}"
            ipv4_gateway: "{{ pfsense_wan.ipv4_gateway }}"
            blockpriv: "{{ pfsense_wan.blockpriv }}"
            blockbogons: "{{ pfsense_wan.blockbogons }}"
            enable: true
            state: present

        - name: Set default gateway
          pfsensible.core.pfsense_default_gateway:
            gateway: "{{ pfsense_wan_gateway.name }}"

        - name: Configure LAN interfaces
          pfsensible.core.pfsense_interface:
            interface: "{{ item.interface }}"
            descr: "{{ item.descr }}"
            ipv4_type: static
            ipv4_address: "{{ item.ipv4_address }}"
            ipv4_prefixlen: "{{ item.ipv4_prefixlen }}"
            enable: true
            state: present
          loop: "{{ pfsense_interfaces }}"
          loop_control:
            label: "{{ item.descr }} ({{ item.ipv4_address }}/{{ item.ipv4_prefixlen }})"

    # =========================================================================
    # PHASE 3: INTERFACE GROUPS
    # =========================================================================
    - name: "PHASE 3: Interface Groups"
      tags: [groups]
      block:
        - name: Create interface groups
          pfsensible.core.pfsense_interface_group:
            name: "{{ item.name }}"
            descr: "{{ item.descr }}"
            members: "{{ item.members }}"
            state: present
          loop: "{{ pfsense_interface_groups }}"
          loop_control:
            label: "{{ item.name }}"

    # =========================================================================
    # PHASE 4: DHCP SERVERS
    # =========================================================================
    - name: "PHASE 4: DHCP Configuration"
      tags: [dhcp]
      block:
        - name: Configure DHCP servers on LAN interfaces
          pfsensible.core.pfsense_dhcp_server:
            interface: "{{ item.interface }}"
            enable: true
            range_from: "{{ item.range_from }}"
            range_to: "{{ item.range_to }}"
            domain: "{{ item.domain }}"
            defaultleasetime: 86400
            maxleasetime: 172800
            state: present
          loop: "{{ pfsense_dhcp_servers }}"
          loop_control:
            label: "{{ item.interface }} ({{ item.range_from }} - {{ item.range_to }})"

    # =========================================================================
    # PHASE 5: FIREWALL ALIASES
    # =========================================================================
    - name: "PHASE 5: Firewall Aliases"
      tags: [aliases]
      block:
        - name: Create firewall aliases
          pfsensible.core.pfsense_alias:
            name: "{{ item.name }}"
            type: "{{ item.type }}"
            descr: "{{ item.descr }}"
            address: "{{ item.address | join(' ') }}"
            state: present
          loop: "{{ pfsense_aliases }}"
          loop_control:
            label: "{{ item.name }} ({{ item.type }})"

    # =========================================================================
    # PHASE 6: FIREWALL RULES
    # =========================================================================
    - name: "PHASE 6: Firewall Rules"
      tags: [rules]
      block:
        - name: Create firewall rules
          pfsensible.core.pfsense_rule:
            name: "{{ item.name }}"
            interface: "{{ item.interface }}"
            action: "{{ item.action }}"
            ipprotocol: inet
            protocol: "{{ item.protocol | default('any') }}"
            source: "{{ item.source }}"
            destination: "{{ item.destination }}"
            destination_port: "{{ item.destination_port | default(omit) }}"
            state: present
          loop: "{{ pfsense_firewall_rules }}"
          loop_control:
            label: "{{ item.name }}"

    # =========================================================================
    # PHASE 7: NAT CONFIGURATION
    # =========================================================================
    - name: "PHASE 7: NAT Configuration"
      tags: [nat]
      block:
        - name: Configure outbound NAT for Management networks
          pfsensible.core.pfsense_nat_outbound:
            descr: "NAT Management Networks"
            interface: "wan"
            source: "ManagementNets"
            destination: "any"
            state: present

        - name: Configure outbound NAT for Development networks
          pfsensible.core.pfsense_nat_outbound:
            descr: "NAT Development Networks"
            interface: "wan"
            source: "DevelopmentNets"
            destination: "any"
            state: present

        - name: Configure outbound NAT for Production networks
          pfsensible.core.pfsense_nat_outbound:
            descr: "NAT Production Networks"
            interface: "wan"
            source: "ProductionNets"
            destination: "any"
            state: present

    # =========================================================================
    # SUMMARY
    # =========================================================================
    - name: Display configuration summary
      tags: [always]
      ansible.builtin.debug:
        msg:
          - "=============================================="
          - "pfSense Configuration Complete (3-Tier)"
          - "=============================================="
          - ""
          - "System:"
          - "  Hostname: {{ pfsense_hostname }}.{{ pfsense_domain }}"
          - "  DNS: {{ pfsense_dns_servers | join(', ') }}"
          - ""
          - "Interfaces (10 total):"
          - "  WAN (em0):          {{ pfsense_wan.ipv4_address }}/{{ pfsense_wan.ipv4_prefixlen }} (GW: {{ pfsense_wan_gateway.gateway }})"
          - "  MGMT_CORE (vtnet0): 10.10.1.1/24"
          - "  MGMT_DEVOPS (vtnet1): 10.10.2.1/24"
          - "  MGMT_OBSERV (vtnet2): 10.10.3.1/24"
          - "  DEV_WEB (vtnet3):   10.20.1.1/24"
          - "  DEV_APPS (vtnet4):  10.20.2.1/24"
          - "  DEV_DATA (vtnet5):  10.20.3.1/24"
          - "  PROD_WEB (vtnet6):  10.30.1.1/24"
          - "  PROD_APPS (vtnet7): 10.30.2.1/24"
          - "  PROD_DATA (vtnet8): 10.30.3.1/24"
          - ""
          - "Interface Groups:"
          - "  Management:  mgmt_core, mgmt_devops, mgmt_observ"
          - "  Development: dev_web, dev_apps, dev_data"
          - "  Production:  prod_web, prod_apps, prod_data"
          - "  WebTier:     dev_web, prod_web"
          - "  AppsTier:    dev_apps, prod_apps"
          - "  DataTier:    dev_data, prod_data"
          - ""
          - "DHCP: Enabled on all 9 LAN interfaces (.100-.200)"
          - "DHCP Search Domain: engatwork.com (all interfaces)"
          - "Firewall: {{ pfsense_firewall_rules | length }} rules configured"
          - "NAT: Outbound NAT for all internal networks"
          - ""
          - "NOTE: Run configure_dns.yml for DNS domain overrides"
          - "=============================================="
