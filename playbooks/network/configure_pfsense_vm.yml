---
# configure_pfsense_vm.yml - Download ISO, create and configure pfSense VM
# Run: ansible-playbook -i inventory.ini network/configure_pfsense_vm.yml
#
# Simplified Architecture (8 interfaces):
#   - WAN (ovirtmgmt)
#   - 3 Management networks (VLAN 10-12)
#   - 2 Development networks (VLAN 20-21)
#   - 2 Production networks (VLAN 30-31)
#
# Post-installation (after pfSense is installed from ISO):
#   ansible-playbook -i inventory.ini network/configure_pfsense_vm.yml --tags post_install_pfsense

- name: Configure pfSense VM
  hosts: engine
  become: true
  gather_facts: false

  vars:
    vm_name: "pfSense"
    vm_memory: 4GiB
    vm_cpu_sockets: 1
    vm_cpu_cores: 2
    vm_disk_size: 50GiB
    storage_domain: "data_lun"
    cluster_name: "Default"

    # pfSense ISO settings
    pfsense_version: "2.7.2"
    iso_name: "pfSense-CE-{{ pfsense_version }}-RELEASE-amd64.iso"
    pfsense_url: "https://atxfiles.netgate.com/mirror/downloads/pfSense-CE-{{ pfsense_version }}-RELEASE-amd64.iso.gz"
    download_dir: "/tmp"

    # pfSense WAN static configuration
    pfsense_wan_mac: "56:6f:1b:6a:00:77"
    pfsense_wan_ip: "192.168.0.101"
    pfsense_wan_gateway: "192.168.0.1"

    # Simplified networks for pfSense (8 interfaces total)
    pfsense_networks:
      # WAN (static MAC for consistent DHCP reservation)
      - name: "ovirtmgmt"
        nic_name: "nic1"
        pfsense_name: "WAN"
        mac_address: "{{ pfsense_wan_mac }}"
        ip_address: "{{ pfsense_wan_ip }}"

      # Management networks (VLAN 10-12)
      - name: "Mgmt-Core-Net"
        nic_name: "nic2"
        pfsense_name: "MGMT_CORE"
        ip_address: "10.10.0.1"

      - name: "Mgmt-DevOps-Net"
        nic_name: "nic3"
        pfsense_name: "MGMT_DEVOPS"
        ip_address: "10.10.1.1"

      - name: "Mgmt-Observ-Net"
        nic_name: "nic4"
        pfsense_name: "MGMT_OBSERV"
        ip_address: "10.10.2.1"

      # Development networks (VLAN 20-21)
      - name: "Dev-Apps-Net"
        nic_name: "nic5"
        pfsense_name: "DEV_APPS"
        ip_address: "10.20.0.1"

      - name: "Dev-Data-Net"
        nic_name: "nic6"
        pfsense_name: "DEV_DATA"
        ip_address: "10.20.1.1"

      # Production networks (VLAN 30-31)
      - name: "Prod-Apps-Net"
        nic_name: "nic7"
        pfsense_name: "PROD_APPS"
        ip_address: "10.30.0.1"

      - name: "Prod-Data-Net"
        nic_name: "nic8"
        pfsense_name: "PROD_DATA"
        ip_address: "10.30.1.1"

  tasks:
    # ==================== DOWNLOAD ISO ====================
    - name: Check if pfSense ISO already exists in oVirt
      ovirt.ovirt.ovirt_auth:
        url: "https://{{ ovirt_engine_fqdn }}/ovirt-engine/api"
        username: "admin@ovirt@internalsso"
        password: "{{ ovirt_engine_admin_password }}"
        insecure: true
      register: ovirt_auth

    - name: Check for existing ISO disk
      ovirt.ovirt.ovirt_disk_info:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        pattern: "name={{ iso_name }}"
      register: iso_check

    - name: Download and upload pfSense ISO if not exists
      when: iso_check.ovirt_disks | length == 0
      block:
        - name: Install required packages
          ansible.builtin.dnf:
            name:
              - gzip
              - python3-ovirt-engine-sdk4
            state: present

        - name: Download pfSense ISO (compressed)
          ansible.builtin.get_url:
            url: "{{ pfsense_url }}"
            dest: "{{ download_dir }}/{{ iso_name }}.gz"
            mode: '0644'
            timeout: 600
          register: download_result

        - name: Decompress pfSense ISO
          ansible.builtin.command:
            cmd: "gunzip -f {{ download_dir }}/{{ iso_name }}.gz"
            creates: "{{ download_dir }}/{{ iso_name }}"

        - name: Get ISO file size
          ansible.builtin.stat:
            path: "{{ download_dir }}/{{ iso_name }}"
          register: iso_stat

        - name: Display ISO info
          ansible.builtin.debug:
            msg: "Downloaded {{ iso_name }} ({{ (iso_stat.stat.size / 1024 / 1024) | round(1) }} MB)"

        - name: Upload pfSense ISO as disk to oVirt
          ovirt.ovirt.ovirt_disk:
            auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
            name: "{{ iso_name }}"
            description: "pfSense CE {{ pfsense_version }} installation ISO"
            storage_domain: "{{ storage_domain }}"
            upload_image_path: "{{ download_dir }}/{{ iso_name }}"
            size: "{{ iso_stat.stat.size }}"
            format: raw
            content_type: iso
            bootable: true
            sparse: false
            wait: true
            timeout: 600

        - name: Clean up downloaded ISO
          ansible.builtin.file:
            path: "{{ download_dir }}/{{ iso_name }}"
            state: absent

    - name: ISO already exists
      ansible.builtin.debug:
        msg: "pfSense ISO already exists in oVirt, skipping download"
      when: iso_check.ovirt_disks | length > 0

    # ==================== CREATE VM ====================
    - name: Create pfSense VM
      ovirt.ovirt.ovirt_vm:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        name: "{{ vm_name }}"
        cluster: "{{ cluster_name }}"
        memory: "{{ vm_memory }}"
        memory_guaranteed: "{{ vm_memory }}"
        memory_max: 8GiB
        cpu_sockets: "{{ vm_cpu_sockets }}"
        cpu_cores: "{{ vm_cpu_cores }}"
        operating_system: other
        type: server
        bios_type: q35_sea_bios
        graphical_console:
          protocol:
            - vnc
        state: present
      register: vm_result

    # ==================== CREATE DISK ====================
    - name: Create pfSense disk
      ovirt.ovirt.ovirt_disk:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        name: "{{ vm_name }}_Disk1"
        vm_name: "{{ vm_name }}"
        size: "{{ vm_disk_size }}"
        format: cow
        storage_domain: "{{ storage_domain }}"
        interface: virtio_scsi
        bootable: true
        state: present
      when: vm_result.changed

    # ==================== ADD vNICs ====================
    - name: Add vNICs to pfSense VM
      ovirt.ovirt.ovirt_nic:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        vm: "{{ vm_name }}"
        name: "{{ item.nic_name }}"
        profile: "{{ item.name }}"
        network: "{{ item.name }}"
        interface: virtio
        mac_address: "{{ item.mac_address | default(omit) }}"
        state: present
      loop: "{{ pfsense_networks }}"
      loop_control:
        label: "{{ item.nic_name }} -> {{ item.name }} ({{ item.pfsense_name }})"

    # ==================== ATTACH ISO AND SET BOOT ORDER ====================
    - name: Attach pfSense ISO and set boot order
      ovirt.ovirt.ovirt_vm:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        name: "{{ vm_name }}"
        cd_iso: "{{ iso_name }}"
        boot_devices:
          - cdrom
          - hd
        state: running

    # ==================== CLEANUP ====================
    - name: Revoke SSO token
      ovirt.ovirt.ovirt_auth:
        state: absent
        ovirt_auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"

    - name: Display summary
      ansible.builtin.debug:
        msg:
          - "=============================================="
          - "pfSense VM Configuration Complete (Simplified)"
          - "=============================================="
          - ""
          - "VM Settings:"
          - "  Name: {{ vm_name }}"
          - "  Memory: {{ vm_memory }}"
          - "  CPU: {{ vm_cpu_sockets }} socket x {{ vm_cpu_cores }} cores"
          - "  Disk: {{ vm_disk_size }} on {{ storage_domain }}"
          - ""
          - "Network Interfaces (8 total):"
          - "  nic1 (vtnet0) -> ovirtmgmt       WAN          {{ pfsense_wan_ip }}"
          - "  nic2 (vtnet1) -> Mgmt-Core-Net   MGMT_CORE    10.10.0.1"
          - "  nic3 (vtnet2) -> Mgmt-DevOps-Net MGMT_DEVOPS  10.10.1.1"
          - "  nic4 (vtnet3) -> Mgmt-Observ-Net MGMT_OBSERV  10.10.2.1"
          - "  nic5 (vtnet4) -> Dev-Apps-Net    DEV_APPS     10.20.0.1"
          - "  nic6 (vtnet5) -> Dev-Data-Net    DEV_DATA     10.20.1.1"
          - "  nic7 (vtnet6) -> Prod-Apps-Net   PROD_APPS    10.30.0.1"
          - "  nic8 (vtnet7) -> Prod-Data-Net   PROD_DATA    10.30.1.1"
          - ""
          - "=============================================="
          - "Next Steps:"
          - "  1. Open noVNC console"
          - "  2. Install pfSense from ISO"
          - "  3. Run: ansible-playbook -i inventory.ini network/configure_pfsense_vm.yml --tags post_install_pfsense"
          - "  4. Configure interfaces with IPs shown above"
          - "  5. Create interface groups (MGMT_GROUP, DEV_GROUP, PROD_GROUP)"
          - "  6. Enable DHCP on each interface"
          - "  7. Set up firewall rules"
          - "=============================================="

# ==================== POST-INSTALLATION PLAY ====================
- name: pfSense Post-Installation - Eject ISO and Configure Boot
  hosts: engine
  become: true
  gather_facts: false
  tags:
    - post_install_pfsense
    - never

  vars:
    vm_name: "pfSense"

  tasks:
    - name: Authenticate to oVirt
      ovirt.ovirt.ovirt_auth:
        url: "https://{{ ovirt_engine_fqdn }}/ovirt-engine/api"
        username: "admin@ovirt@internalsso"
        password: "{{ ovirt_engine_admin_password }}"
        insecure: true
      register: ovirt_auth

    - name: Get VM info
      ovirt.ovirt.ovirt_vm_info:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        pattern: "name={{ vm_name }}"
      register: vm_info

    - name: Stop pfSense VM if running
      ovirt.ovirt.ovirt_vm:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        name: "{{ vm_name }}"
        state: stopped
        wait: true
      when: vm_info.ovirt_vms[0].status == 'up'

    - name: Eject ISO and set boot order to HD only
      ovirt.ovirt.ovirt_vm:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        name: "{{ vm_name }}"
        cd_iso: ""
        boot_devices:
          - hd
        state: present

    - name: Start pfSense VM
      ovirt.ovirt.ovirt_vm:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        name: "{{ vm_name }}"
        state: running
        wait: true

    - name: Wait for VM to fully boot
      ansible.builtin.pause:
        seconds: 30
        prompt: "Waiting for pfSense to boot..."

    - name: Ensure all vNICs are linked and plugged
      ovirt.ovirt.ovirt_nic:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        vm: "{{ vm_name }}"
        name: "nic{{ item }}"
        linked: true
        state: present
      loop: "{{ range(1, 9) | list }}"
      loop_control:
        label: "nic{{ item }}"

    - name: Hot-replug WAN NIC to force link detection
      block:
        - name: Unplug WAN NIC (nic1)
          ovirt.ovirt.ovirt_nic:
            auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
            vm: "{{ vm_name }}"
            name: "nic1"
            linked: false
            state: present

        - name: Wait briefly
          ansible.builtin.pause:
            seconds: 2

        - name: Plug WAN NIC back in
          ovirt.ovirt.ovirt_nic:
            auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
            vm: "{{ vm_name }}"
            name: "nic1"
            linked: true
            state: present

    - name: Revoke SSO token
      ovirt.ovirt.ovirt_auth:
        state: absent
        ovirt_auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"

    - name: Display post-install summary
      ansible.builtin.debug:
        msg:
          - "=============================================="
          - "pfSense Post-Installation Complete"
          - "=============================================="
          - ""
          - "Completed:"
          - "  - ISO ejected"
          - "  - Boot order set to HD only"
          - "  - VM started"
          - "  - All 8 NICs linked and plugged"
          - ""
          - "Configure pfSense interfaces:"
          - "  WAN (vtnet0):        192.168.0.101/24 GW: 192.168.0.1"
          - "  MGMT_CORE (vtnet1):  10.10.0.1/24"
          - "  MGMT_DEVOPS (vtnet2): 10.10.1.1/24"
          - "  MGMT_OBSERV (vtnet3): 10.10.2.1/24"
          - "  DEV_APPS (vtnet4):   10.20.0.1/24"
          - "  DEV_DATA (vtnet5):   10.20.1.1/24"
          - "  PROD_APPS (vtnet6):  10.30.0.1/24"
          - "  PROD_DATA (vtnet7):  10.30.1.1/24"
          - "=============================================="
