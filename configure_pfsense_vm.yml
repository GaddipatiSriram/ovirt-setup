---
# configure_pfsense_vm.yml - Create and configure pfSense VM
# Run: ansible-playbook -i inventory.ini configure_pfsense_vm.yml
#
# This playbook:
#   1. Creates pfSense VM with recommended specs
#   2. Attaches pfSense ISO for installation
#   3. Configures all 21 vNICs (WAN + 20 VLANs)
#   4. Sets proper boot order and display settings

- name: Configure pfSense VM
  hosts: engine
  become: true
  gather_facts: false

  vars:
    vm_name: "pfSense"
    vm_memory: 4GiB
    vm_cpu_sockets: 1
    vm_cpu_cores: 2
    vm_disk_size: 50GiB
    storage_domain: "data_lun"
    cluster_name: "Default"
    iso_name: "pfSense-CE-2.7.2-RELEASE-amd64.iso"

    # All networks for pfSense routing
    pfsense_networks:
      # WAN/Management
      - name: "ovirtmgmt"
        nic_name: "nic1"

      # Management VLANs (10-16)
      - name: "Mgmt-Core-Net"
        nic_name: "nic2"
      - name: "Mgmt-DMZ-Net"
        nic_name: "nic3"
      - name: "Mgmt-Observability-Net"
        nic_name: "nic4"
      - name: "Mgmt-DevOps-Net"
        nic_name: "nic5"
      - name: "Mgmt-Identity-Net"
        nic_name: "nic6"
      - name: "Mgmt-Security-Net"
        nic_name: "nic7"
      - name: "Mgmt-Backup-Net"
        nic_name: "nic8"

      # Development VLANs (21-25)
      - name: "Dev-DMZ-Net"
        nic_name: "nic9"
      - name: "Dev-Web-Net"
        nic_name: "nic10"
      - name: "Dev-App-Net"
        nic_name: "nic11"
      - name: "Dev-Database-Net"
        nic_name: "nic12"
      - name: "Dev-Messaging-Net"
        nic_name: "nic13"

      # Production VLANs (31-39)
      - name: "Prod-DMZ-Net"
        nic_name: "nic14"
      - name: "Prod-Web-Net"
        nic_name: "nic15"
      - name: "Prod-App-Net"
        nic_name: "nic16"
      - name: "Prod-Database-Net"
        nic_name: "nic17"
      - name: "Prod-Messaging-Net"
        nic_name: "nic18"
      - name: "Prod-Cache-Net"
        nic_name: "nic19"
      - name: "Prod-API-Net"
        nic_name: "nic20"
      - name: "Prod-DR-Net"
        nic_name: "nic21"

  tasks:
    - name: Obtain SSO token from oVirt Engine
      ovirt.ovirt.ovirt_auth:
        url: "https://{{ ovirt_engine_fqdn }}/ovirt-engine/api"
        username: "admin@ovirt@internalsso"
        password: "{{ ovirt_engine_admin_password }}"
        insecure: true
      register: ovirt_auth

    # ==================== CREATE VM ====================
    - name: Create pfSense VM
      ovirt.ovirt.ovirt_vm:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        name: "{{ vm_name }}"
        cluster: "{{ cluster_name }}"
        memory: "{{ vm_memory }}"
        memory_guaranteed: "{{ vm_memory }}"
        memory_max: 8GiB
        cpu_sockets: "{{ vm_cpu_sockets }}"
        cpu_cores: "{{ vm_cpu_cores }}"
        operating_system: freebsd
        type: server
        bios_type: i440fx_sea_bios
        display: vnc
        state: present
      register: vm_result

    # ==================== CREATE DISK ====================
    - name: Create pfSense disk
      ovirt.ovirt.ovirt_disk:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        name: "{{ vm_name }}_Disk1"
        vm_name: "{{ vm_name }}"
        size: "{{ vm_disk_size }}"
        format: cow
        storage_domain: "{{ storage_domain }}"
        interface: virtio_scsi
        bootable: true
        state: present
      when: vm_result.changed

    # ==================== ATTACH ISO ====================
    - name: Attach pfSense ISO
      ovirt.ovirt.ovirt_disk:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        name: "{{ iso_name }}"
        vm_name: "{{ vm_name }}"
        interface: ide
        state: attached
      ignore_errors: true

    # ==================== SET BOOT ORDER ====================
    - name: Set boot order (HD first, then CDROM)
      ovirt.ovirt.ovirt_vm:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        name: "{{ vm_name }}"
        boot_devices:
          - hd
          - cdrom
        state: present

    # ==================== ADD vNICs ====================
    - name: Add vNICs to pfSense VM
      ovirt.ovirt.ovirt_nic:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        vm: "{{ vm_name }}"
        name: "{{ item.nic_name }}"
        profile: "{{ item.name }}"
        network: "{{ item.name }}"
        interface: virtio
        state: present
      loop: "{{ pfsense_networks }}"
      loop_control:
        label: "{{ item.nic_name }} -> {{ item.name }}"

    # ==================== CLEANUP ====================
    - name: Revoke SSO token
      ovirt.ovirt.ovirt_auth:
        state: absent
        ovirt_auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"

    - name: Display summary
      ansible.builtin.debug:
        msg:
          - "=============================================="
          - "pfSense VM Configuration Complete"
          - "=============================================="
          - ""
          - "VM Settings:"
          - "  Name: {{ vm_name }}"
          - "  Memory: {{ vm_memory }}"
          - "  CPU: {{ vm_cpu_sockets }} socket x {{ vm_cpu_cores }} cores"
          - "  Disk: {{ vm_disk_size }} on {{ storage_domain }}"
          - "  Display: VNC (virtio-vga)"
          - "  BIOS: i440fx SeaBIOS"
          - ""
          - "Network Interfaces (21 total):"
          - "  nic1  -> ovirtmgmt        (WAN)"
          - "  nic2  -> Mgmt-Core-Net    (VLAN 10 - 10.10.0.1)"
          - "  nic3  -> Mgmt-DMZ-Net     (VLAN 11 - 10.10.1.1)"
          - "  nic4  -> Mgmt-Observ.     (VLAN 12 - 10.10.2.1)"
          - "  nic5  -> Mgmt-DevOps      (VLAN 13 - 10.10.3.1)"
          - "  nic6  -> Mgmt-Identity    (VLAN 14 - 10.10.4.1)"
          - "  nic7  -> Mgmt-Security    (VLAN 15 - 10.10.5.1)"
          - "  nic8  -> Mgmt-Backup      (VLAN 16 - 10.10.6.1)"
          - "  nic9  -> Dev-DMZ-Net      (VLAN 21 - 10.20.1.1)"
          - "  nic10 -> Dev-Web-Net      (VLAN 22 - 10.20.2.1)"
          - "  nic11 -> Dev-App-Net      (VLAN 23 - 10.20.3.1)"
          - "  nic12 -> Dev-Database     (VLAN 24 - 10.20.4.1)"
          - "  nic13 -> Dev-Messaging    (VLAN 25 - 10.20.5.1)"
          - "  nic14 -> Prod-DMZ-Net     (VLAN 31 - 10.30.1.1)"
          - "  nic15 -> Prod-Web-Net     (VLAN 32 - 10.30.2.1)"
          - "  nic16 -> Prod-App-Net     (VLAN 33 - 10.30.3.1)"
          - "  nic17 -> Prod-Database    (VLAN 34 - 10.30.4.1)"
          - "  nic18 -> Prod-Messaging   (VLAN 35 - 10.30.5.1)"
          - "  nic19 -> Prod-Cache       (VLAN 36 - 10.30.6.1)"
          - "  nic20 -> Prod-API-Net     (VLAN 37 - 10.30.7.1)"
          - "  nic21 -> Prod-DR-Net      (VLAN 39 - 10.30.9.1)"
          - ""
          - "=============================================="
          - "Next Steps:"
          - "  1. Start VM and open console"
          - "  2. Install pfSense from ISO"
          - "  3. Configure WAN interface (DHCP or static)"
          - "  4. Configure LAN interfaces with gateway IPs"
          - "  5. Set up firewall rules between VLANs"
          - "=============================================="
