---
# configure_pfsense_vm.yml - Download ISO, create and configure pfSense VM
# Run: ansible-playbook -i inventory.ini configure_pfsense_vm.yml
#
# This playbook:
#   1. Downloads pfSense ISO and uploads to oVirt
#   2. Creates pfSense VM with recommended specs
#   3. Attaches pfSense ISO for installation
#   4. Configures all 21 vNICs (WAN + 20 VLANs)
#   5. Sets proper boot order and display settings
#
# Post-installation (after pfSense is installed from ISO):
#   ansible-playbook -i inventory.ini network/configure_pfsense_vm.yml --tags post_install_pfsense
#
# This will:
#   - Stop the VM
#   - Eject the ISO
#   - Set boot order to HD only
#   - Start the VM
#   - Ensure all NICs are linked and plugged
#   - Hot-replug WAN NIC to force link detection

- name: Configure pfSense VM
  hosts: engine
  become: true
  gather_facts: false

  vars:
    vm_name: "pfSense"
    vm_memory: 4GiB
    vm_cpu_sockets: 1
    vm_cpu_cores: 2
    vm_disk_size: 50GiB
    storage_domain: "data_lun"
    cluster_name: "Default"

    # pfSense ISO settings
    pfsense_version: "2.7.2"
    iso_name: "pfSense-CE-{{ pfsense_version }}-RELEASE-amd64.iso"
    pfsense_url: "https://atxfiles.netgate.com/mirror/downloads/pfSense-CE-{{ pfsense_version }}-RELEASE-amd64.iso.gz"
    download_dir: "/tmp"

    # pfSense WAN static configuration
    # MAC is set during deployment; IP must be configured in pfSense console
    # (pfSense does not support cloud-init)
    pfsense_wan_mac: "56:6f:1b:6a:00:77"
    pfsense_wan_ip: "192.168.0.101"  # Configure manually in pfSense: WAN -> Static IP
    pfsense_wan_gateway: "192.168.0.1"

    # All networks for pfSense routing
    pfsense_networks:
      # WAN/Management (static MAC for consistent DHCP reservation)
      - name: "ovirtmgmt"
        nic_name: "nic1"
        mac_address: "{{ pfsense_wan_mac }}"

      # Management VLANs (10-16)
      - name: "Mgmt-Core-Net"
        nic_name: "nic2"
      - name: "Mgmt-DMZ-Net"
        nic_name: "nic3"
      - name: "Mgmt-Observability-Net"
        nic_name: "nic4"
      - name: "Mgmt-DevOps-Net"
        nic_name: "nic5"
      - name: "Mgmt-Identity-Net"
        nic_name: "nic6"
      - name: "Mgmt-Security-Net"
        nic_name: "nic7"
      - name: "Mgmt-Backup-Net"
        nic_name: "nic8"

      # Development VLANs (21-25)
      - name: "Dev-DMZ-Net"
        nic_name: "nic9"
      - name: "Dev-Web-Net"
        nic_name: "nic10"
      - name: "Dev-App-Net"
        nic_name: "nic11"
      - name: "Dev-Database-Net"
        nic_name: "nic12"
      - name: "Dev-Messaging-Net"
        nic_name: "nic13"

      # Production VLANs (31-39)
      - name: "Prod-DMZ-Net"
        nic_name: "nic14"
      - name: "Prod-Web-Net"
        nic_name: "nic15"
      - name: "Prod-App-Net"
        nic_name: "nic16"
      - name: "Prod-Database-Net"
        nic_name: "nic17"
      - name: "Prod-Messaging-Net"
        nic_name: "nic18"
      - name: "Prod-Cache-Net"
        nic_name: "nic19"
      - name: "Prod-API-Net"
        nic_name: "nic20"
      - name: "Prod-DR-Net"
        nic_name: "nic21"

  tasks:
    # ==================== DOWNLOAD ISO ====================
    - name: Check if pfSense ISO already exists in oVirt
      ovirt.ovirt.ovirt_auth:
        url: "https://{{ ovirt_engine_fqdn }}/ovirt-engine/api"
        username: "admin@ovirt@internalsso"
        password: "{{ ovirt_engine_admin_password }}"
        insecure: true
      register: ovirt_auth

    - name: Check for existing ISO disk
      ovirt.ovirt.ovirt_disk_info:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        pattern: "name={{ iso_name }}"
      register: iso_check

    - name: Download and upload pfSense ISO if not exists
      when: iso_check.ovirt_disks | length == 0
      block:
        - name: Install required packages
          ansible.builtin.dnf:
            name:
              - gzip
              - python3-ovirt-engine-sdk4
            state: present

        - name: Download pfSense ISO (compressed)
          ansible.builtin.get_url:
            url: "{{ pfsense_url }}"
            dest: "{{ download_dir }}/{{ iso_name }}.gz"
            mode: '0644'
            timeout: 600
          register: download_result

        - name: Decompress pfSense ISO
          ansible.builtin.command:
            cmd: "gunzip -f {{ download_dir }}/{{ iso_name }}.gz"
            creates: "{{ download_dir }}/{{ iso_name }}"

        - name: Get ISO file size
          ansible.builtin.stat:
            path: "{{ download_dir }}/{{ iso_name }}"
          register: iso_stat

        - name: Display ISO info
          ansible.builtin.debug:
            msg: "Downloaded {{ iso_name }} ({{ (iso_stat.stat.size / 1024 / 1024) | round(1) }} MB)"

        - name: Upload pfSense ISO as disk to oVirt
          ovirt.ovirt.ovirt_disk:
            auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
            name: "{{ iso_name }}"
            description: "pfSense CE {{ pfsense_version }} installation ISO"
            storage_domain: "{{ storage_domain }}"
            upload_image_path: "{{ download_dir }}/{{ iso_name }}"
            size: "{{ iso_stat.stat.size }}"
            format: raw
            content_type: iso
            bootable: true
            sparse: false
            wait: true
            timeout: 600

        - name: Clean up downloaded ISO
          ansible.builtin.file:
            path: "{{ download_dir }}/{{ iso_name }}"
            state: absent

    - name: ISO already exists
      ansible.builtin.debug:
        msg: "pfSense ISO already exists in oVirt, skipping download"
      when: iso_check.ovirt_disks | length > 0

    # ==================== CREATE VM ====================
    - name: Create pfSense VM
      ovirt.ovirt.ovirt_vm:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        name: "{{ vm_name }}"
        cluster: "{{ cluster_name }}"
        memory: "{{ vm_memory }}"
        memory_guaranteed: "{{ vm_memory }}"
        memory_max: 8GiB
        cpu_sockets: "{{ vm_cpu_sockets }}"
        cpu_cores: "{{ vm_cpu_cores }}"
        operating_system: other
        type: server
        bios_type: q35_sea_bios
        graphical_console:
          protocol:
            - vnc
        state: present
      register: vm_result

    # ==================== CREATE DISK ====================
    - name: Create pfSense disk
      ovirt.ovirt.ovirt_disk:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        name: "{{ vm_name }}_Disk1"
        vm_name: "{{ vm_name }}"
        size: "{{ vm_disk_size }}"
        format: cow
        storage_domain: "{{ storage_domain }}"
        interface: virtio_scsi
        bootable: true
        state: present
      when: vm_result.changed

    # ==================== ADD vNICs (VM must be stopped) ====================
    - name: Add vNICs to pfSense VM
      ovirt.ovirt.ovirt_nic:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        vm: "{{ vm_name }}"
        name: "{{ item.nic_name }}"
        profile: "{{ item.name }}"
        network: "{{ item.name }}"
        interface: virtio
        mac_address: "{{ item.mac_address | default(omit) }}"
        state: present
      loop: "{{ pfsense_networks }}"
      loop_control:
        label: "{{ item.nic_name }} -> {{ item.name }}"

    # ==================== ATTACH ISO AND SET BOOT ORDER ====================
    - name: Attach pfSense ISO and set boot order
      ovirt.ovirt.ovirt_vm:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        name: "{{ vm_name }}"
        cd_iso: "{{ iso_name }}"
        boot_devices:
          - cdrom
          - hd
        state: running

    # ==================== CLEANUP ====================
    - name: Revoke SSO token
      ovirt.ovirt.ovirt_auth:
        state: absent
        ovirt_auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"

    - name: Display summary
      ansible.builtin.debug:
        msg:
          - "=============================================="
          - "pfSense VM Configuration Complete"
          - "=============================================="
          - ""
          - "VM Settings:"
          - "  Name: {{ vm_name }}"
          - "  Memory: {{ vm_memory }}"
          - "  CPU: {{ vm_cpu_sockets }} socket x {{ vm_cpu_cores }} cores"
          - "  Disk: {{ vm_disk_size }} on {{ storage_domain }}"
          - "  Display: VNC"
          - "  BIOS: Q35 SeaBIOS"
          - ""
          - "Network Interfaces (21 total):"
          - "  nic1  -> ovirtmgmt        (WAN)"
          - "  nic2  -> Mgmt-Core-Net    (VLAN 10 - 10.10.0.1)"
          - "  nic3  -> Mgmt-DMZ-Net     (VLAN 11 - 10.10.1.1)"
          - "  nic4  -> Mgmt-Observ.     (VLAN 12 - 10.10.2.1)"
          - "  nic5  -> Mgmt-DevOps      (VLAN 13 - 10.10.3.1)"
          - "  nic6  -> Mgmt-Identity    (VLAN 14 - 10.10.4.1)"
          - "  nic7  -> Mgmt-Security    (VLAN 15 - 10.10.5.1)"
          - "  nic8  -> Mgmt-Backup      (VLAN 16 - 10.10.6.1)"
          - "  nic9  -> Dev-DMZ-Net      (VLAN 21 - 10.20.1.1)"
          - "  nic10 -> Dev-Web-Net      (VLAN 22 - 10.20.2.1)"
          - "  nic11 -> Dev-App-Net      (VLAN 23 - 10.20.3.1)"
          - "  nic12 -> Dev-Database     (VLAN 24 - 10.20.4.1)"
          - "  nic13 -> Dev-Messaging    (VLAN 25 - 10.20.5.1)"
          - "  nic14 -> Prod-DMZ-Net     (VLAN 31 - 10.30.1.1)"
          - "  nic15 -> Prod-Web-Net     (VLAN 32 - 10.30.2.1)"
          - "  nic16 -> Prod-App-Net     (VLAN 33 - 10.30.3.1)"
          - "  nic17 -> Prod-Database    (VLAN 34 - 10.30.4.1)"
          - "  nic18 -> Prod-Messaging   (VLAN 35 - 10.30.5.1)"
          - "  nic19 -> Prod-Cache       (VLAN 36 - 10.30.6.1)"
          - "  nic20 -> Prod-API-Net     (VLAN 37 - 10.30.7.1)"
          - "  nic21 -> Prod-DR-Net      (VLAN 39 - 10.30.9.1)"
          - ""
          - "=============================================="
          - "WAN Static Configuration:"
          - "  MAC: {{ pfsense_wan_mac }}"
          - "  IP:  {{ pfsense_wan_ip }}/24"
          - "  GW:  {{ pfsense_wan_gateway }}"
          - ""
          - "Next Steps:"
          - "  1. Open noVNC console"
          - "  2. Install pfSense from ISO"
          - "  3. Run post-install: ansible-playbook -i inventory.ini network/configure_pfsense_vm.yml --tags post_install_pfsense"
          - "  4. Configure WAN: Static IP {{ pfsense_wan_ip }}/24, Gateway {{ pfsense_wan_gateway }}"
          - "  5. Configure LAN (vtnet1): 10.10.0.1/24 (Mgmt-Core-Net)"
          - "  6. Configure remaining OPT interfaces with gateway IPs"
          - "  7. Set up firewall rules between VLANs"
          - "=============================================="

# ==================== POST-INSTALLATION PLAY ====================
- name: pfSense Post-Installation - Eject ISO and Configure Boot
  hosts: engine
  become: true
  gather_facts: false
  tags:
    - post_install_pfsense
    - never

  vars:
    vm_name: "pfSense"
    iso_name: "pfSense-CE-2.7.2-RELEASE-amd64.iso"

  tasks:
    - name: Authenticate to oVirt
      ovirt.ovirt.ovirt_auth:
        url: "https://{{ ovirt_engine_fqdn }}/ovirt-engine/api"
        username: "admin@ovirt@internalsso"
        password: "{{ ovirt_engine_admin_password }}"
        insecure: true
      register: ovirt_auth

    - name: Get VM info
      ovirt.ovirt.ovirt_vm_info:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        pattern: "name={{ vm_name }}"
      register: vm_info

    - name: Stop pfSense VM if running
      ovirt.ovirt.ovirt_vm:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        name: "{{ vm_name }}"
        state: stopped
        wait: true
      when: vm_info.ovirt_vms[0].status == 'up'

    - name: Eject ISO and set boot order to HD only
      ovirt.ovirt.ovirt_vm:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        name: "{{ vm_name }}"
        cd_iso: ""
        boot_devices:
          - hd
        state: present

    - name: Start pfSense VM
      ovirt.ovirt.ovirt_vm:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        name: "{{ vm_name }}"
        state: running
        wait: true

    - name: Wait for VM to fully boot
      ansible.builtin.pause:
        seconds: 30
        prompt: "Waiting for pfSense to boot..."

    - name: Ensure all vNICs are linked and plugged
      ovirt.ovirt.ovirt_nic:
        auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
        vm: "{{ vm_name }}"
        name: "nic{{ item }}"
        linked: true
        state: present
      loop: "{{ range(1, 22) | list }}"
      loop_control:
        label: "nic{{ item }}"

    - name: Hot-replug WAN NIC to force link detection
      block:
        - name: Unplug WAN NIC (nic1)
          ovirt.ovirt.ovirt_nic:
            auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
            vm: "{{ vm_name }}"
            name: "nic1"
            linked: false
            state: present

        - name: Wait briefly
          ansible.builtin.pause:
            seconds: 2

        - name: Plug WAN NIC back in
          ovirt.ovirt.ovirt_nic:
            auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"
            vm: "{{ vm_name }}"
            name: "nic1"
            linked: true
            state: present

    - name: Revoke SSO token
      ovirt.ovirt.ovirt_auth:
        state: absent
        ovirt_auth: "{{ ovirt_auth.ansible_facts.ovirt_auth }}"

    - name: Display post-install summary
      ansible.builtin.debug:
        msg:
          - "=============================================="
          - "pfSense Post-Installation Complete"
          - "=============================================="
          - ""
          - "Completed:"
          - "  - ISO ejected"
          - "  - Boot order set to HD only"
          - "  - VM started"
          - "  - All NICs linked and plugged"
          - "  - WAN NIC hot-replugged for link detection"
          - ""
          - "Next Steps:"
          - "  1. Open noVNC console"
          - "  2. Verify WAN (vtnet0) shows link up"
          - "  3. Assign interfaces if prompted"
          - "  4. Configure WAN IP (DHCP or static)"
          - "  5. Access webConfigurator at WAN IP"
          - "=============================================="
